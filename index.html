<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Bangladesh Flight Map - Waypoints Pro</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { 
  margin: 0; 
  padding: 0; 
  font-family: Arial, sans-serif;
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

#map { 
  flex: 0 0 65vh;
  width: 100%;
  position: relative;
}

#sidebar { 
  flex: 1;
  width: 100%;
  padding: 16px;
  background: #f7f7f7;
  overflow-y: auto;
  border-top: 2px solid #2a9df4;
  box-sizing: border-box;
}

#credit {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(255,255,255,0.9);
  font-size: 13px;
  color: #333;
  padding: 6px 12px;
  border-radius: 4px;
  border: 1px solid #ccc;
  font-weight: bold;
  z-index: 1000;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.controls-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.control-section {
  background: white;
  padding: 12px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.control-section h4 {
  margin: 0 0 10px 0;
  font-size: 14px;
  color: #333;
  border-bottom: 2px solid #2a9df4;
  padding-bottom: 4px;
}

.btn { 
  display: inline-block; 
  padding: 8px 14px; 
  margin: 4px 3px; 
  background: #2a9df4; 
  color: white; 
  border-radius: 5px; 
  text-decoration: none; 
  cursor: pointer; 
  font-size: 14px;
  border: none;
  transition: background 0.2s;
}

.btn:hover {
  background: #1f7fc7;
}

.btn.small { 
  padding: 4px 8px; 
  font-size: 12px;
  margin: 2px;
}

input[type=text], input[type=number], textarea { 
  box-sizing: border-box; 
  padding: 8px; 
  margin: 4px 0;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

textarea {
  width: 100%;
}

.waypoint-list-container {
  max-height: 200px;
  overflow-y: auto;
  background: white;
  padding: 8px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.waypoint-item { 
  border-bottom: 1px dashed #ccc; 
  padding: 8px; 
  margin-bottom: 6px;
  background: #fafafa;
  border-radius: 4px;
}

.waypoint-item:last-child {
  border-bottom: none;
}

.waypoint-actions { 
  margin-top: 6px;
}

.small { 
  font-size: 12px; 
  color: #666; 
}

#speedInput { 
  width: 80px; 
  display: inline-block;
}

#routeSummary { 
  font-size: 13px; 
  margin-top: 8px;
  padding: 10px;
  background: white;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  max-height: 150px;
  overflow-y: auto;
}

.coord-input-group {
  display: grid;
  grid-template-columns: auto 1fr 1fr;
  gap: 6px;
  align-items: center;
  margin-bottom: 8px;
}

.coord-input-group label {
  font-size: 13px;
  font-weight: bold;
  width: 30px;
}

.coord-input-group input {
  margin: 0;
  width: 100%;
}

.route-controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.import-export-controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}

.section-header {
  margin: 16px 0 8px 0;
  font-size: 15px;
  font-weight: bold;
  color: #2a9df4;
}

#coordsOut {
  padding: 8px;
  background: white;
  border-radius: 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-top: 8px;
}

/* Responsive adjustments for iPad landscape */
@media (orientation: landscape) and (min-width: 800px) {
  #map {
    flex: 0 0 68vh;
  }
  
  .controls-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}
</style>
</head>
<body>

<div id="map">
  <div id="credit">MADE BY LT CDR SADMAN, P NO 3223</div>
</div>

<div id="sidebar">
  <div style="text-align: center; margin-bottom: 12px;">
    <h3 style="margin: 0 0 4px 0; color: #2a9df4;">Waypoint Tool</h3>
    <small class="small">Click map to add waypoint ‚Ä¢ Click waypoint to select/edit</small>
  </div>

  <div class="controls-grid">
    <!-- Jump To Section -->
    <div class="control-section">
      <h4>üìç Jump To Location</h4>
      <div class="coord-input-group">
        <label>Lat:</label>
        <input id="latDeg" placeholder="Deg" type="number"/>
        <input id="latMin" placeholder="Min" type="number" step="0.001"/>
      </div>
      <div class="coord-input-group">
        <label>Lon:</label>
        <input id="lonDeg" placeholder="Deg" type="number"/>
        <input id="lonMin" placeholder="Min" type="number" step="0.001"/>
      </div>
      <a id="goBtn" class="btn" style="width: 100%; text-align: center; margin-top: 4px;">Go/Add</a>
    </div>

    <!-- Speed & Route Section -->
    <div class="control-section">
      <h4>‚úàÔ∏è Route Planning</h4>
      <div style="margin-bottom: 8px;">
        <label style="font-size: 13px;">Speed (knots):</label>
        <input id="speedInput" placeholder="kn" type="text" value=""/>
      </div>
      <div class="route-controls">
        <a id="routeBtn" class="btn">Route Selected</a>
        <a id="clearRouteBtn" class="btn" style="background:#999">Clear Route</a>
      </div>
    </div>
  </div>

  <!-- Waypoints List -->
  <div class="section-header">üìã Waypoints List</div>
  <div class="waypoint-list-container">
    <div id="list"></div>
  </div>

  <!-- Import/Export -->
  <div class="section-header">üíæ Import/Export</div>
  <div class="import-export-controls">
    <a id="saveBtn" class="btn" style="background:#28a745">üíæ Save</a>
    <a id="exportBtn" class="btn" style="background:#6c757d">üì• Export JSON</a>
    <a id="importBtn" class="btn" style="background:#ffc107">üì§ Import</a>
  </div>
  <textarea id="jsonArea" rows="3" placeholder="Paste JSON here for import"></textarea>

  <!-- Coordinates Display -->
  <div class="section-header">üéØ Current Coordinates</div>
  <div id="coordsOut" class="small">Click on map to see coordinates</div>
  
  <!-- Route Summary -->
  <div id="routeSummary" class="small"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const imageUrl = 'map.png';
const bounds = [[21.00, 89.00],[24.00, 92.00]];

const map = L.map('map', {minZoom:2, maxZoom:18}).fitBounds(bounds);
L.imageOverlay(imageUrl, bounds).addTo(map);

let waypoints = [];
let markers = {};
let selected = [];
let routeLayer = null;
let checkpointMarkers = [];

const listDiv = document.getElementById('list');
const coordsOut = document.getElementById('coordsOut');
const routeSummaryDiv = document.getElementById('routeSummary');

// --- COORDINATE CONVERSION FUNCTIONS ---
function decimalToDMS(decimal) {
  const absolute = Math.abs(decimal);
  const degrees = Math.floor(absolute);
  const minutes = (absolute - degrees) * 60;
  return { degrees, minutes };
}

function dmsToDecimal(degrees, minutes) {
  const decimal = Math.abs(degrees) + (minutes / 60);
  return degrees < 0 ? -decimal : decimal;
}

function formatCoordinate(decimal, isLatitude) {
  const dms = decimalToDMS(decimal);
  const direction = isLatitude 
    ? (decimal >= 0 ? 'N' : 'S') 
    : (decimal >= 0 ? 'E' : 'W');
  return `${dms.degrees}¬∞ ${dms.minutes.toFixed(3)}' ${direction}`;
}

// --- FUNCTIONS ---
function renderList(){
  listDiv.innerHTML = '';
  if(waypoints.length === 0) {
    listDiv.innerHTML = '<div class="small" style="text-align:center; padding:20px; color:#999;">No waypoints yet. Click on map to add.</div>';
    return;
  }
  waypoints.forEach(w=>{
    const div = document.createElement('div');
    div.className = 'waypoint-item';
    const latStr = formatCoordinate(w.lat, true);
    const lonStr = formatCoordinate(w.lon, false);
    div.innerHTML = `
      <b>${w.name}</b><br>
      <span class="small">${latStr}, ${lonStr}</span>
      <div class="waypoint-actions">
        <a class="btn small" onclick="editWaypoint(${w.id})">‚úèÔ∏è Edit</a>
        <a class="btn small" style="background:#dc3545" onclick="deleteWaypoint(${w.id})">üóëÔ∏è Delete</a>
        <a class="btn small" style="background:#6f42c1" onclick="selectWaypoint(${w.id})">üéØ Select</a>
      </div>
    `;
    listDiv.appendChild(div);
  });
}

function addWaypoint(lat,lon,name){
  const id = Date.now()+Math.floor(Math.random()*999);
  const wp = {id,lat,lon,name:name||('WP-'+(waypoints.length+1))};
  waypoints.push(wp);
  const latStr = formatCoordinate(lat, true);
  const lonStr = formatCoordinate(lon, false);
  const marker = L.circleMarker([lat,lon],{radius:6,color:'#f00',fillColor:'#f00',fillOpacity:0.9})
    .addTo(map)
    .bindPopup(`<b>${wp.name}</b><br>${latStr}<br>${lonStr}<br><a href="#" onclick="editWaypoint(${wp.id})">Edit</a>`);
  marker.on('click',()=>selectWaypoint(wp.id));
  markers[id]=marker;
  renderList();
  saveLocal();
}

function editWaypoint(id){
  const wp = waypoints.find(w=>w.id===id);
  if(!wp)return;
  const newName = prompt('Rename waypoint:', wp.name);
  if(newName!==null && newName.trim()!==''){ wp.name = newName.trim(); }
  const newLat = prompt('Change latitude (decimal):', wp.lat);
  const newLon = prompt('Change longitude (decimal):', wp.lon);
  if(newLat && newLon && !isNaN(newLat) && !isNaN(newLon)){
    wp.lat=parseFloat(newLat); wp.lon=parseFloat(newLon);
    const latStr = formatCoordinate(wp.lat, true);
    const lonStr = formatCoordinate(wp.lon, false);
    markers[id].setLatLng([wp.lat,wp.lon])
      .bindPopup(`<b>${wp.name}</b><br>${latStr}<br>${lonStr}<br><a href="#" onclick="editWaypoint(${wp.id})">Edit</a>`);
  }
  renderList();
  saveLocal();
}

function deleteWaypoint(id){
  if(!confirm('Delete this waypoint?'))return;
  waypoints=waypoints.filter(w=>w.id!==id);
  map.removeLayer(markers[id]);
  delete markers[id];
  renderList();
  saveLocal();
}

function selectWaypoint(id){
  const idx = selected.indexOf(id);
  if(idx===-1) selected.push(id);
  else selected.splice(idx,1);
  Object.keys(markers).forEach(k=>{
    const mk=markers[k];
    if(selected.includes(Number(k))) mk.setStyle({color:'#00f',fillColor:'#00f'});
    else mk.setStyle({color:'#f00',fillColor:'#f00'});
  });
}

// --- DISTANCE & BEARING ---
function haversineNM(lat1,lon1,lat2,lon2){
  const R=6371e3, toRad=v=>v*Math.PI/180;
  const œÜ1=toRad(lat1),œÜ2=toRad(lat2),ŒîœÜ=toRad(lat2-lat1),ŒîŒª=toRad(lon2-lon1);
  const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))/1852; // NM
}
function bearing(lat1,lon1,lat2,lon2){
  const toRad=v=>v*Math.PI/180,toDeg=v=>v*180/Math.PI;
  const œÜ1=toRad(lat1),œÜ2=toRad(lat2),Œª1=toRad(lon1),Œª2=toRad(lon2);
  const y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

// --- ROUTE & CHECKPOINTS ---
function makeRoute(){
  if(selected.length<2){alert('Select at least 2 waypoints'); return;}
  if(routeLayer) map.removeLayer(routeLayer);
  checkpointMarkers.forEach(cp=>map.removeLayer(cp));
  checkpointMarkers=[];

  const latlngs = selected.map(id=>{ const w=waypoints.find(wp=>wp.id===id); return [w.lat,w.lon]; });
  routeLayer=L.polyline(latlngs,{color:'#ff6600',weight:2}).addTo(map);

  let cumulativeDistance=0;
  let cumulativeTime=0;
  const speed=parseFloat(document.getElementById('speedInput').value)||0;

  routeSummaryDiv.innerHTML='<div class="section-header">üìä Route Summary</div>';
  for(let i=0;i<selected.length-1;i++){
    const a=waypoints.find(w=>w.id===selected[i]);
    const b=waypoints.find(w=>w.id===selected[i+1]);
    const dist=haversineNM(a.lat,a.lon,b.lat,b.lon);
    cumulativeDistance+=dist;
    const time=speed>0 ? (dist/speed*60) : 0; // minutes
    cumulativeTime+=time;
    const brg=bearing(a.lat,a.lon,b.lat,b.lon);
    routeSummaryDiv.innerHTML+=`<b>${a.name} ‚Üí ${b.name}</b>: ${dist.toFixed(2)} NM, ${brg.toFixed(1)}¬∞, Leg Time: ${time.toFixed(1)} min<br>`;
  }
  routeSummaryDiv.innerHTML+=`<br><b>Total Distance:</b> ${cumulativeDistance.toFixed(2)} NM<br><b>Total Time:</b> ${cumulativeTime.toFixed(1)} min`;

  routeLayer.on('click',function(e){
    addCheckpoint(e.latlng);
  });
}

function addCheckpoint(latlng){
  let prevLatLng = selected.length>0 ? waypoints.find(w=>w.id===selected[0]) : map.getCenter();
  if(checkpointMarkers.length>0){
    prevLatLng = checkpointMarkers[checkpointMarkers.length-1].getLatLng();
  }
  const dist = haversineNM(prevLatLng.lat,prevLatLng.lng,latlng.lat,latlng.lng);
  const speed = parseFloat(document.getElementById('speedInput').value)||0;
  const eta = speed>0 ? (dist/speed*60).toFixed(1)+' min' : 'N/A';
  const cpMarker = L.circleMarker([latlng.lat,latlng.lng],{radius:4,color:'#0a0',fillColor:'#0a0',fillOpacity:0.8})
    .addTo(map)
    .bindPopup(`Checkpoint<br>Distance: ${dist.toFixed(2)} NM<br>ETA @${speed} kn: ${eta}`)
    .openPopup()
    .bindTooltip(`Distance: ${dist.toFixed(2)} NM, ETA: ${eta}`, {permanent:true, direction:'top'});
  checkpointMarkers.push(cpMarker);
}

function clearRoute(){
  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer=null;
  checkpointMarkers.forEach(cp=>map.removeLayer(cp));
  checkpointMarkers=[];
  selected=[];
  routeSummaryDiv.innerHTML='';
  Object.values(markers).forEach(m=>m.setStyle({color:'#f00',fillColor:'#f00'}));
}

// --- LOCAL STORAGE ---
function saveLocal(){ localStorage.setItem('map_waypoints_v4',JSON.stringify(waypoints)); }
function loadLocal(){
  const data=localStorage.getItem('map_waypoints_v4');
  if(!data)return;
  try{ const arr=JSON.parse(data); arr.forEach(w=>addWaypoint(w.lat,w.lon,w.name)); }
  catch(e){console.error(e);}
}

// --- EVENTS ---
map.on('click',e=>{
  const latStr = formatCoordinate(e.latlng.lat, true);
  const lonStr = formatCoordinate(e.latlng.lng, false);
  coordsOut.textContent=`${latStr}, ${lonStr}`;
  addWaypoint(e.latlng.lat,e.latlng.lng);
});

document.getElementById('goBtn').onclick=()=>{
  const latDeg=parseFloat(document.getElementById('latDeg').value);
  const latMin=parseFloat(document.getElementById('latMin').value);
  const lonDeg=parseFloat(document.getElementById('lonDeg').value);
  const lonMin=parseFloat(document.getElementById('lonMin').value);
  
  if(isNaN(latDeg)||isNaN(latMin)||isNaN(lonDeg)||isNaN(lonMin)){
    alert('Invalid coordinates - please enter all fields'); 
    return;
  }
  
  const lat = dmsToDecimal(latDeg, latMin);
  const lon = dmsToDecimal(lonDeg, lonMin);
  
  map.setView([lat,lon],Math.max(map.getZoom(),12));
  addWaypoint(lat,lon,'Manual');
  
  document.getElementById('latDeg').value = '';
  document.getElementById('latMin').value = '';
  document.getElementById('lonDeg').value = '';
  document.getElementById('lonMin').value = '';
};

document.getElementById('routeBtn').onclick=makeRoute;
document.getElementById('clearRouteBtn').onclick=clearRoute;
document.getElementById('saveBtn').onclick=()=>{ saveLocal(); alert('Waypoints saved to browser storage!'); };
document.getElementById('exportBtn').onclick=()=>{
  const blob=new Blob([JSON.stringify(waypoints,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='waypoints.json'; a.click();
};
document.getElementById('importBtn').onclick=()=>{
  try{ 
    const arr=JSON.parse(document.getElementById('jsonArea').value); 
    arr.forEach(w=>addWaypoint(w.lat,w.lon,w.name)); 
    document.getElementById('jsonArea').value = '';
    alert('Waypoints imported successfully!');
  }
  catch(e){alert('Invalid JSON format');}
};

// INIT
loadLocal();

// Fix map size on load
setTimeout(() => {
  map.invalidateSize();
}, 100);
</script>
</body>
</html>
